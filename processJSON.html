<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="exificient.js"></script>
<script type="text/javascript" src="exificient4json.js"></script>  

<!-- CodeMirror - normal stuff -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/codemirror.min.css">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/codemirror.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/mode/xml/xml.min.js"></script>

<!-- CodeMirror - foldable -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/addon/fold/foldgutter.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/addon/fold/foldgutter.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/addon/fold/brace-fold.min.js"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/addon/fold/xml-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.5.0/addon/fold/comment-fold.min.js"></script>

<!-- CodeMirror - formatting removed after version 2 ? -->
<script src="http://codemirror.net/2/lib/util/formatting.js"></script>

</head>

<body>
<p style="font-size:x-small"><a href="index.html">Home</a> | <span style="color: Gray;">Process JSON</span> </p>


<script>


function writeUint18ArrayBufferToEXIEditor(uint8Array, uint8ArrayLength) {
	var hex = "";
	for(var i=0; i<uint8ArrayLength; i++) {
		var sh = uint8Array[i].toString(16); // base 16 (hex)
		if(sh.length == 1) {
			sh = "0" + sh;
		}
		// hex +=	"0x" + sh + " ";
		hex +=	sh + " ";			
		if((i+1) % 16 == 0) {
			hex += "\n"
		}
	}
	// editorEXI.setValue("len = " + uint8ArrayLength + "\n" + hex);
	editorEXI.setValue(hex);
}

//shared strings
// var sharedStrings = ["@context","@id","@value","@type","xsd:string","xsd:boolean","xsd:unsignedShort","xsd:unsignedByte", "xsd:float","http://w3c.github.io/wot/w3c-wot-td-context.jsonld","metadata","name","protocols","uri","priority","encodings","interactions","outputData","inputData","writable","Property","Action","Event","CoAP","HTTP","JSON","EXI", "WS"];

function getSharedStrings() {
	var ssv = document.getElementById('sharedStrings').value;
	
	if(ssv.trim().length == 0) {
		return null;
	} else {
		try {
			var sharedStrings = JSON.parse("[" + ssv + "]");
			return sharedStrings;
		} catch(e){
			alert("Shared String parsing error: " + e);
		}
	}
}

function encodeJSON() {
	var textJSON = editorJSON.getValue();
	if(textJSON.trim().length == 0) {
		alert("No JSON provided");
	} else {
		var exiEncoder = new EXI4JSONEncoder();	
		
		// shared strings
		exiEncoder.initSharedStrings(getSharedStrings());
		
		// encode
		exiEncoder.encodeJsonText(textJSON);
		
		var uint8ArrayLength = exiEncoder.getUint8ArrayLength();
		var uint8Array = exiEncoder.getUint8Array();
		writeUint18ArrayBufferToEXIEditor(uint8Array, uint8ArrayLength);
		
		// alert("Encoded JSON (" + textJSON.length +" Bytes) into EXI (" + uint8ArrayLength + " Bytes)");
		var c = document.getElementById('container');
		while(c.hasChildNodes()) {
			c.removeChild(c.childNodes[0]); // Remove first child node (index 0)
		}
		c.appendChild( pieChart(((uint8ArrayLength/textJSON.length)*100), 70 ) );
		var textnode = document.createTextNode(" " + new Date().toLocaleTimeString() + ": Encoded JSON (" + textJSON.length +" Bytes) into EXI (" + uint8ArrayLength + " Bytes)"); 
		c.appendChild(textnode); 
	}
}

function decodeEXI4JSON() {
	var textEXI = editorEXI.getValue();
	textEXI = textEXI.trim();
	if(textEXI.length == 0) {
		alert("No EXI provided");
	} else {
		// remove multiple spaces
		textEXI = textEXI.replace(/ +(?= )/g,'');
		var sp = textEXI.split(" "); 
		var arrayBuffer = new ArrayBuffer(sp.length);
		var arrayBufferView = new Uint8Array(arrayBuffer);
		// alert("TODO EXI " + sp.length + ": " + sp);
		for(var i=0; i<sp.length; i++) {
			arrayBufferView[i] = parseInt(sp[i], 16);
		}
		
		var exiDecoder = new EXI4JSONDecoder(arrayBuffer);
		
		// shared strings
		exiDecoder.initSharedStrings(getSharedStrings());
		
		// register XML handler
		var jsonHandler = new JSONEventHandler();
		exiDecoder.registerEventHandler(jsonHandler);
		exiDecoder.decode();
		var jsonText = JSON.stringify(jsonHandler.getJSON(), null, "\t");
		editorJSON.setValue(jsonText);
		
		// alert("Decoded EXI (" + sp.length +" Bytes) into JSON (" + jsonText.length + " Bytes)");
		var c = document.getElementById('container');
		while(c.hasChildNodes()) {
			c.removeChild(c.childNodes[0]); // Remove first child node (index 0)
		}
		c.appendChild( pieChart(((sp.length/jsonText.length)*100), 70 ) );
		var textnode = document.createTextNode(" " + new Date().toLocaleTimeString() + ": Decoded EXI (" + sp.length +" Bytes) into JSON (" + jsonText.length + " Bytes)"); 
		c.appendChild(textnode); 
	}
}



function readXMLFile() {
	var file = document.getElementById('jsonInput').files[0];
	if(file == null || file === undefined) {
		alert("No JSON File selected");
		return;
	}
	var reader = new FileReader();
	
	reader.onload = function(event) {
		var buffer = event.target.result;
		editorJSON.setValue(buffer);
	};

	reader.onerror = function(event) {
		console.error("File could not be read! Code " + event.target.error.code);
	};

	// reader.readAsArrayBuffer(file);
	reader.readAsText(file);
}

function readEXI4JSONFile() {
	var file = document.getElementById('exiInput').files[0];
	if(file == null || file === undefined) {
		alert("No EXI File selected");
		return;
	}
	var reader = new FileReader();
	
	reader.onload = function(event) {
		var buffer = event.target.result;
		var uint8Array = new Uint8Array(buffer);
		writeUint18ArrayBufferToEXIEditor(uint8Array, uint8Array.length);
		// editorEXI.setValue(buffer);
	};

	reader.onerror = function(event) {
		console.error("File could not be read! Code " + event.target.error.code);
	};

	reader.readAsArrayBuffer(file);
	// reader.readAsText(file);
}

</script> 


<h1>JSON/EXI processing</h1>


<div id="container" style="height: 70px">
</div>

<script>
function pieChart(percentage, size, color) {
    var svgns = "http://www.w3.org/2000/svg";
    var chart = document.createElementNS(svgns, "svg:svg");
    chart.setAttribute("width", size);
    chart.setAttribute("height", size);
    chart.setAttribute("viewBox", "0 0 " + size + " " + size);
    // Background circle
    var back = document.createElementNS(svgns, "circle");
    back.setAttributeNS(null, "cx", size / 2);
    back.setAttributeNS(null, "cy", size / 2);
    back.setAttributeNS(null, "r",  size / 2);
    var color = "#d0d0d0";
    if (size > 50) { 
        color = "#ebebeb";
    }
    back.setAttributeNS(null, "fill", color);
    chart.appendChild(back);
    // primary wedge
    var path = document.createElementNS(svgns, "path");
    var unit = (Math.PI *2) / 100;    
    var startangle = 0;
    var endangle = percentage * unit - 0.001;
    var x1 = (size / 2) + (size / 2) * Math.sin(startangle);
    var y1 = (size / 2) - (size / 2) * Math.cos(startangle);
    var x2 = (size / 2) + (size / 2) * Math.sin(endangle);
    var y2 = (size / 2) - (size / 2) * Math.cos(endangle);
    var big = 0;
    if (endangle - startangle > Math.PI) {
        big = 1;
    }
    var d = "M " + (size / 2) + "," + (size / 2) +  // Start at circle center
        " L " + x1 + "," + y1 +     // Draw line to (x1,y1)
        " A " + (size / 2) + "," + (size / 2) +       // Draw an arc of radius r
        " 0 " + big + " 1 " +       // Arc details...
        x2 + "," + y2 +             // Arc goes to to (x2,y2)
        " Z";                       // Close path back to (cx,cy)
    path.setAttribute("d", d); // Set this path 
    path.setAttribute("fill", '#f05f3b');
    chart.appendChild(path); // Add wedge to chart
    // foreground circle
    var front = document.createElementNS(svgns, "circle");
    front.setAttributeNS(null, "cx", (size / 2));
    front.setAttributeNS(null, "cy", (size / 2));
    front.setAttributeNS(null, "r",  (size * 0.17)); //about 34% as big as back circle 
    front.setAttributeNS(null, "fill", "#fff");
    chart.appendChild(front);
    return chart;
}
</script>



<br />
<table style="width:95%; border:none" >
	<tr>
		<td colspan="3">SharedStrings (a.k.a. shared vocabulary). Note: delete if not needed: 
		<textarea id="sharedStrings" rows="3" style="width:100%" >
"@context","@id","@value","@type","xsd:string","xsd:boolean","xsd:unsignedShort","xsd:unsignedByte", "xsd:float","http://w3c.github.io/wot/w3c-wot-td-context.jsonld","metadata","name","protocols","uri","priority","encodings","interactions","outputData","inputData","writable","Property","Action","Event","CoAP","HTTP","JSON","EXI", "WS"</textarea>
		</td>
	</tr>
	<tr>
		<td>JSON</td>
		<td></td>
		<td>EXI4JSON (binary)</td>
	</tr>
	<tr>
		<td style="width:50%">
			<!-- readonly="readonly"  -->
			<textarea id="codeJSON" name="codeJSON">{
	"test": true
}
</textarea>
		</td>
		<td>
			<button type="button" onclick="javascript:encodeJSON()">Encode &rarr;</button>
			<br />
			<br />
			<br />
			<br />
			<button type="button" onclick="javascript:decodeEXI4JSON()">&larr; Decode</button>
		</td>
		<td style="width:50%">
			<!-- readonly="readonly" -->
			<textarea id="codeEXI" name="codeEXI"  ></textarea>
		</td>
	</tr>
	<!-- -->
	<tr id="myOptionsRow">
		<td>
			<input type="file" id="jsonInput" />
			<label for="jsonInput">Choose or drag an XML file</label>
			<br />
			<button type="button" onclick="javascript:readXMLFile()">Parse selected XML file into editor</button>
		</td>
		<td>
		</td>
		<td>
			<input type="file" id="exiInput" />
			<label for="exiInput">Choose or drag an EXI file</label>
			<br />
			<button type="button" onclick="javascript:readEXI4JSONFile()">Parse selected EXI4JSON file into editor</button>	
		</td>
	</tr>
</table>


<button type="button" onclick="javascript:switchOptionsOnOff()">Options on/off</button>
<script  type="text/javascript">
function switchOptionsOnOff() {
	var id = "myOptionsRow";
	if( document.getElementById(id).style.display == 'none') {
		document.getElementById(id).style.display='block'; 
	} else {
		document.getElementById(id).style.display='none'; 
	}
	// document.getElementById(id).style.display='none';
	// document.getElementById(id).style.display='block';  
}
// default: make it unvisible
switchOptionsOnOff();
</script>



 <script  type="text/javascript">
//<![CDATA[
	var editorJSON = CodeMirror.fromTextArea(document.getElementById("codeJSON"), {
	  mode: "application/json",
	  styleActiveLine: true,
	  foldGutter: true,
	  gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
	  lineNumbers: true,
	  lineWrapping: true,
	  readOnly: false
	});
	
	// editorXML.setSize("99%", "200px"); // null possible
	
	var editorEXI = CodeMirror.fromTextArea(document.getElementById("codeEXI"), {
	  mode: "application/octet-stream",
	  styleActiveLine: true,
	  foldGutter: true,
	  gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
	  lineNumbers: true,
	  lineWrapping: true,
	  readOnly: false
	});
//]]>
</script> 
 

</body>
</html> 
